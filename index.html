<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLB Game Day Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
            color: #f9fafb; /* text-gray-50 */
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.7);
        }
        .modal {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .stat-table th, .stat-table td {
            padding: 0.75rem 0.5rem;
            text-align: center;
        }
        .stat-table th:first-child, .stat-table td:first-child {
            text-align: left;
            padding-left: 1rem;
        }
        .stat-table tbody tr:nth-child(even) {
            background-color: #1f2937; /* bg-gray-800 */
        }
        .loader {
            border-top-color: #3b82f6;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        #download-all-csv-btn:disabled {
            cursor: not-allowed;
            background-color: #374151; /* bg-gray-700 */
        }
    </style>
</head>
<body class="antialiased">

    <div id="app-container" class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white tracking-tight">MLB Game Day</h1>
            <p class="text-lg text-gray-400 mt-2">Browse daily MLB schedules and box scores.</p>
        </header>

        <div class="max-w-xl mx-auto mb-8 flex flex-col sm:flex-row gap-4 items-center">
            <div class="w-full sm:w-auto flex-grow">
                <label for="game-date-picker" class="block text-sm font-medium text-gray-300 mb-2">Select Date:</label>
                <input type="date" id="game-date-picker" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-white">
            </div>
            <div class="w-full sm:w-auto pt-0 sm:pt-7">
                 <button id="download-all-csv-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold px-4 py-2.5 rounded-md flex items-center justify-center text-sm">
                    <span id="download-btn-text">
                        <i data-lucide="download" class="inline-block w-4 h-4 mr-2"></i>
                        Download All Games (CSV)
                    </span>
                    <span id="download-btn-loader" class="hidden">
                        <div class="loader ease-linear rounded-full border-2 border-t-2 border-gray-200 h-5 w-5 mr-2 inline-block"></div>
                        Fetching data...
                    </span>
                </button>
            </div>
        </div>

        <main id="games-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Game cards will be injected here -->
        </main>
        
        <div id="loader" class="text-center py-12 hidden">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mx-auto"></div>
            <p class="mt-4 text-gray-400">Fetching game data...</p>
        </div>
        
        <div id="no-games-message" class="text-center py-12 hidden">
             <i data-lucide="calendar-x" class="mx-auto h-16 w-16 text-gray-500"></i>
            <p class="mt-4 text-xl text-gray-400">No games scheduled for this date.</p>
        </div>

    </div>

    <!-- Box Score Modal -->
    <div id="boxscore-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div id="modal-content" class="bg-gray-900 rounded-lg shadow-2xl w-full max-w-6xl max-h-[95vh] flex flex-col modal opacity-0 transform scale-95">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center flex-shrink-0">
                <h3 class="text-xl md:text-2xl font-semibold" id="modal-title">Box Score</h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-white">
                    <i data-lucide="x" class="w-8 h-8"></i>
                </button>
            </div>
            <div id="modal-body" class="p-2 md:p-4 lg:p-6 overflow-y-auto">
                <!-- Box score content will be injected here -->
            </div>
             <div id="modal-loader" class="text-center py-12 hidden">
                <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mx-auto"></div>
                <p class="mt-4 text-gray-400">Fetching box score...</p>
            </div>
        </div>
    </div>


    <script type="module">
        // --- DOM Elements ---
        const gameDatePicker = document.getElementById('game-date-picker');
        const gamesGrid = document.getElementById('games-grid');
        const loader = document.getElementById('loader');
        const noGamesMessage = document.getElementById('no-games-message');
        const downloadAllCsvBtn = document.getElementById('download-all-csv-btn');
        const downloadBtnText = document.getElementById('download-btn-text');
        const downloadBtnLoader = document.getElementById('download-btn-loader');
        
        const boxscoreModal = document.getElementById('boxscore-modal');
        const modalContent = document.getElementById('modal-content');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalLoader = document.getElementById('modal-loader');

        // --- API Configuration ---
        const API_BASE_URL = 'https://statsapi.mlb.com/api/v1';

        // --- App State ---
        let currentGames = [];

        // --- Functions ---
        
        /**
         * Fetches and displays games for a given date
         * @param {string} dateString The date in YYYY-MM-DD format
         */
        async function fetchAndDisplayGames(dateString) {
            gamesGrid.innerHTML = '';
            currentGames = [];
            noGamesMessage.classList.add('hidden');
            loader.classList.remove('hidden');
            downloadAllCsvBtn.disabled = true;

            try {
                const response = await fetch(`${API_BASE_URL}/schedule?sportId=1&date=${dateString}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();

                if (data.totalGames === 0) {
                    noGamesMessage.classList.remove('hidden');
                } else {
                    currentGames = data.dates[0].games;
                    renderGames(currentGames);
                    downloadAllCsvBtn.disabled = false;
                }
            } catch (error) {
                console.error("Error fetching schedule:", error);
                gamesGrid.innerHTML = `<p class="text-red-400 text-center col-span-full">Could not fetch game data. Please try again later.</p>`;
            } finally {
                loader.classList.add('hidden');
            }
        }

        /**
         * Renders game cards to the grid
         * @param {Array} games Array of game objects from the API
         */
        function renderGames(games) {
            gamesGrid.innerHTML = '';
            games.forEach(game => {
                const gameCard = document.createElement('div');
                gameCard.className = 'bg-gray-800 rounded-lg p-4 flex flex-col cursor-pointer hover:ring-2 ring-blue-500 transition-all duration-200';
                gameCard.dataset.gamePk = game.gamePk;

                const awayTeam = game.teams.away;
                const homeTeam = game.teams.home;
                const status = game.status.detailedState;
                
                gameCard.innerHTML = `
                    <div class="flex-grow">
                        <p class="text-sm text-gray-400 mb-2">${status} - ${new Date(game.gameDate).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-semibold text-lg">${awayTeam.team.name}</span>
                            <span class="font-bold text-2xl">${awayTeam.score ?? 0}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="font-semibold text-lg">${homeTeam.team.name}</span>
                            <span class="font-bold text-2xl">${homeTeam.score ?? 0}</span>
                        </div>
                    </div>
                    <div class="border-t border-gray-700 mt-4 pt-2 text-xs text-gray-400">
                        <p>W: ${game.decisions?.winner?.fullName || 'TBD'}</p>
                        <p>L: ${game.decisions?.loser?.fullName || 'TBD'}</p>
                        ${game.decisions?.save ? `<p>S: ${game.decisions.save.fullName}</p>` : ''}
                    </div>
                `;
                gamesGrid.appendChild(gameCard);
            });
            lucide.createIcons();
        }

        /**
         * Fetches and displays the box score for a specific game
         * @param {string} gamePk The unique ID for the game
         */
        async function fetchAndDisplayBoxscore(gamePk) {
            openModal();
            modalBody.innerHTML = '';
            modalLoader.classList.remove('hidden');

            try {
                const response = await fetch(`${API_BASE_URL}/game/${gamePk}/boxscore`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                renderBoxscore(data);
            } catch (error) {
                console.error("Error fetching boxscore:", error);
                modalBody.innerHTML = `<p class="text-red-400 text-center">Could not fetch box score data.</p>`;
            } finally {
                modalLoader.classList.add('hidden');
            }
        }

        /**
         * Renders the detailed box score inside the modal
         * @param {Object} data The boxscore data from the API
         */
        function renderBoxscore(data) {
            const { away, home } = data.teams;
            modalTitle.textContent = `${away.team.name} @ ${home.team.name}`;
            
            const createPlayerTable = (teamData, type) => {
                const players = teamData.players;
                const playerIDs = type === 'batting' ? teamData.batters : teamData.pitchers;
                const statsType = type === 'batting' ? 'batting' : 'pitching';
                const headers = type === 'batting' 
                    ? ['AB', 'R', 'H', 'RBI', 'BB', 'SO', 'LOB', 'AVG'] 
                    : ['IP', 'H', 'R', 'ER', 'BB', 'SO', 'HR', 'ERA'];

                let tableRows = '';
                playerIDs.forEach(playerID => {
                     const player = players[`ID${playerID}`];
                     if (player && player.stats[statsType]) {
                        const stats = player.stats[statsType];
                        tableRows += `
                            <tr>
                                <td class="whitespace-nowrap">${player.person.fullName} <span class="text-gray-400">${player.position.abbreviation}</span></td>
                                ${ type === 'batting' ? `
                                <td>${stats.atBats ?? 0}</td><td>${stats.runs ?? 0}</td><td>${stats.hits ?? 0}</td>
                                <td>${stats.rbi ?? 0}</td><td>${stats.baseOnBalls ?? 0}</td><td>${stats.strikeOuts ?? 0}</td>
                                <td>${stats.leftOnBase ?? 0}</td><td>${player.seasonStats.batting.avg ?? '.---'}</td>
                                ` : `
                                <td>${stats.inningsPitched ?? '0.0'}</td><td>${stats.hits ?? 0}</td><td>${stats.runs ?? 0}</td>
                                <td>${stats.earnedRuns ?? 0}</td><td>${stats.baseOnBalls ?? 0}</td><td>${stats.strikeOuts ?? 0}</td>
                                <td>${stats.homeRuns ?? 0}</td><td>${player.seasonStats.pitching.era ?? '-.--'}</td>
                                `}
                            </tr>
                        `;
                     }
                });

                return `
                    <div class="mb-8">
                        <h4 class="text-xl font-semibold mb-2">${teamData.team.name} ${type.charAt(0).toUpperCase() + type.slice(1)}</h4>
                        <div class="overflow-x-auto rounded-lg border border-gray-700">
                            <table class="min-w-full divide-y divide-gray-700 stat-table">
                                <thead class="bg-gray-800"><tr><th class="text-left">Player</th>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                                <tbody class="divide-y divide-gray-700">${tableRows}</tbody>
                            </table>
                        </div>
                    </div>
                `;
            };

            modalBody.innerHTML = `
                ${createPlayerTable(away, 'batting')}
                ${createPlayerTable(home, 'batting')}
                ${createPlayerTable(away, 'pitching')}
                ${createPlayerTable(home, 'pitching')}
            `;
        }
        
        /**
         * Fetches all data for a day and triggers a CSV download
         */
        async function downloadAllGamesCSV() {
            if (currentGames.length === 0) {
                alert("No games to download for the selected date.");
                return;
            }

            downloadAllCsvBtn.disabled = true;
            downloadBtnText.classList.add('hidden');
            downloadBtnLoader.classList.remove('hidden');

            try {
                const gameDataPromises = currentGames.map(game => {
                    const boxscorePromise = fetch(`${API_BASE_URL}/game/${game.gamePk}/boxscore`).then(res => res.json());
                    const linescorePromise = fetch(`${API_BASE_URL}/game/${game.gamePk}/linescore`).then(res => res.json());
                    return Promise.all([boxscorePromise, linescorePromise]);
                });

                const allGamesData = await Promise.all(gameDataPromises);

                const csvContent = allGamesData.map(([boxscore, linescore]) => {
                    return convertGameDataToCSVString(boxscore, linescore);
                }).join('\n\n\n'); // Add extra newlines between games

                triggerCSVDownload(csvContent);

            } catch (error) {
                console.error("Error downloading all game data:", error);
                alert("Failed to download all game data. Please check the console for errors.");
            } finally {
                downloadAllCsvBtn.disabled = false;
                downloadBtnText.classList.remove('hidden');
                downloadBtnLoader.classList.add('hidden');
            }
        }

        /**
         * Converts a single game's data into a CSV formatted string.
         * @param {object} boxscore - The boxscore data for a game.
         * @param {object} linescore - The linescore data for a game.
         * @returns {string} A CSV formatted string for one game.
         */
        function convertGameDataToCSVString(boxscore, linescore) {
            const { away, home } = boxscore.teams;
            let csv = [];

            // Game Header
            csv.push(`"Game: ${away.team.name} @ ${home.team.name}"`);
            csv.push(`"Date: ${gameDatePicker.value}"`);
            csv.push('');

            // Linescore
            csv.push('"Linescore"');
            const inningHeaders = linescore.innings.map(i => i.num).join(',');
            csv.push(`Team,${inningHeaders},R,H,E`);
            const awayLine = `"${away.team.name}",${linescore.innings.map(i => i.away.runs ?? 0).join(',')},${linescore.teams.away.runs},${linescore.teams.away.hits},${linescore.teams.away.errors}`;
            const homeLine = `"${home.team.name}",${linescore.innings.map(i => i.home.runs ?? 0).join(',')},${linescore.teams.home.runs},${linescore.teams.home.hits},${linescore.teams.home.errors}`;
            csv.push(awayLine);
            csv.push(homeLine);
            csv.push('');

            // Batting and Pitching stats
            const processTeam = (teamData) => {
                // Batting
                csv.push(`"${teamData.team.name} - Batting"`);
                csv.push('Player,Position,AB,R,H,RBI,BB,SO,LOB,AVG');
                teamData.batters.forEach(id => {
                    const p = teamData.players[`ID${id}`];
                    if (p && p.stats.batting) {
                        const s = p.stats.batting;
                        csv.push(`"${p.person.fullName}",${p.position.abbreviation},${s.atBats ?? 0},${s.runs ?? 0},${s.hits ?? 0},${s.rbi ?? 0},${s.baseOnBalls ?? 0},${s.strikeOuts ?? 0},${s.leftOnBase ?? 0},${p.seasonStats.batting.avg ?? 'N/A'}`);
                    }
                });
                csv.push('');

                // Pitching
                csv.push(`"${teamData.team.name} - Pitching"`);
                csv.push('Player,Position,IP,H,R,ER,BB,SO,HR,ERA');
                teamData.pitchers.forEach(id => {
                    const p = teamData.players[`ID${id}`];
                    if (p && p.stats.pitching) {
                        const s = p.stats.pitching;
                        csv.push(`"${p.person.fullName}",${p.position.abbreviation},${s.inningsPitched ?? '0.0'},${s.hits ?? 0},${s.runs ?? 0},${s.earnedRuns ?? 0},${s.baseOnBalls ?? 0},${s.strikeOuts ?? 0},${s.homeRuns ?? 0},${p.seasonStats.pitching.era ?? 'N/A'}`);
                    }
                });
            };

            processTeam(away);
            csv.push('');
            processTeam(home);

            return csv.join('\n');
        }

        /**
         * Triggers the download of the generated CSV file
         * @param {string} csvData - The complete CSV string to download.
         */
        function triggerCSVDownload(csvData) {
            // Add BOM for Excel compatibility
            const blob = new Blob(['\uFEFF' + csvData], { type: 'text/csv;charset=utf-8;' });
            const date = gameDatePicker.value;
            const filename = `mlb_games_${date}.csv`;

            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function openModal() {
            boxscoreModal.classList.remove('hidden');
            setTimeout(() => modalContent.classList.remove('opacity-0', 'scale-95'), 10);
        }

        function closeModal() {
            modalContent.classList.add('opacity-0', 'scale-95');
            setTimeout(() => boxscoreModal.classList.add('hidden'), 300);
        }

        // --- Event Listeners ---
        gameDatePicker.addEventListener('change', () => fetchAndDisplayGames(gameDatePicker.value));
        gamesGrid.addEventListener('click', (e) => {
            const gameCard = e.target.closest('[data-game-pk]');
            if (gameCard) fetchAndDisplayBoxscore(gameCard.dataset.gamePk);
        });

        closeModalBtn.addEventListener('click', closeModal);
        downloadAllCsvBtn.addEventListener('click', downloadAllGamesCSV);
        boxscoreModal.addEventListener('click', (e) => {
            if (e.target === boxscoreModal) closeModal();
        });

        // --- Initialization ---
        function init() {
            const today = new Date();
            const offset = today.getTimezoneOffset();
            const localToday = new Date(today.getTime() - (offset * 60 * 1000));
            gameDatePicker.value = localToday.toISOString().split('T')[0];
            
            fetchAndDisplayGames(gameDatePicker.value);
            lucide.createIcons();
        }

        init();

    </script>
</body>
</html>
